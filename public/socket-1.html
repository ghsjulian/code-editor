<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent WebSocket Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        #status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }
        
        .connected {
            background-color: #4CAF50;
            color: white;
        }
        
        .connecting {
            background-color: #FFC107;
            color: black;
        }
        
        .disconnected {
            background-color: #F44336;
            color: white;
        }
        
        #messages {
            height: 300px;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            overflow-y: auto;
            background-color: white;
            border-radius: 5px;
        }
        
        #form {
            display: flex;
            gap: 10px;
        }
        
        #input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        button {
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            background-color: #9E9E9E;
            cursor: not-allowed;
        }
        
        .message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            background-color: #E3F2FD;
        }
        
        .error {
            background-color: #FFEBEE;
        }
        
        .system {
            background-color: #FFF8E1;
            text-align: center;
        }
        
        .timestamp {
            font-size: 0.8em;
            color: #757575;
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <h1>Persistent WebSocket Client</h1>
    <div id="status" class="disconnected">Disconnected</div>
    
    <div id="messages"></div>
    
    <div id="form">
        <input type="text" id="input" placeholder="Type your message..." disabled>
        <button id="send" disabled>Send</button>
    </div>

    <script>
        // Configuration
        const WS_URL = 'ws://localhost:9000';
        const RECONNECT_DELAY = 3000; // 3 seconds
        const PING_INTERVAL = 20000; // 20 seconds
        const MAX_RECONNECT_ATTEMPTS = 10;
        
        // DOM Elements
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        
        // State
        let socket = null;
        let reconnectCount = 0;
        let pingTimer = null;
        let reconnectTimer = null;
        let isManualClose = false;
        
        // Initialize WebSocket connection
        function connect() {
            // Clear any existing timers
            clearTimers();
            
            // Update UI
            updateStatus('connecting', 'Connecting...');
            inputEl.disabled = true;
            sendBtn.disabled = true;
            
            // Create new WebSocket connection
            socket = new WebSocket(WS_URL);
            
            // Connection opened
            socket.onopen = (event) => {
                logSystemMessage('Connected to server');
                updateStatus('connected', 'Connected');
                reconnectCount = 0;
                inputEl.disabled = false;
                sendBtn.disabled = false;
                
                // Start ping interval
                startPing();
            };
            
            // Message received
            socket.onmessage = (event) => {
                logMessage('Received: ' + event.data);
            };
            
            // Connection closed
            socket.onclose = (event) => {
                logSystemMessage(`Disconnected: ${getCloseReason(event.code)}`);
                
                if (!isManualClose) {
                    updateStatus('disconnected', 'Disconnected - Reconnecting...');
                    attemptReconnect();
                } else {
                    updateStatus('disconnected', 'Disconnected');
                }
                
                inputEl.disabled = true;
                sendBtn.disabled = true;
            };
            
            // Connection error
            socket.onerror = (error) => {
                logErrorMessage('Connection error: ' + error.message);
            };
        }
        
        // Attempt to reconnect
        function attemptReconnect() {
            if (reconnectCount >= MAX_RECONNECT_ATTEMPTS) {
                logSystemMessage('Max reconnection attempts reached');
                return;
            }
            
            reconnectCount++;
            const delay = Math.min(RECONNECT_DELAY * reconnectCount, 30000); // Cap at 30s
            
            logSystemMessage(`Attempting to reconnect (${reconnectCount}/${MAX_RECONNECT_ATTEMPTS}) in ${delay/1000} seconds...`);
            
            reconnectTimer = setTimeout(() => {
                connect();
            }, delay);
        }
        
        // Start ping interval
        function startPing() {
            pingTimer = setInterval(() => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
                }
            }, PING_INTERVAL);
        }
        
        // Clear all timers
        function clearTimers() {
            if (pingTimer) clearInterval(pingTimer);
            if (reconnectTimer) clearTimeout(reconnectTimer);
            pingTimer = null;
            reconnectTimer = null;
        }
        
        // Update connection status UI
        function updateStatus(state, text) {
            statusEl.className = state;
            statusEl.textContent = text;
        }
        
        // Log messages to UI
        function logMessage(text) {
            const msgEl = document.createElement('div');
            msgEl.className = 'message';
            msgEl.innerHTML = `
                <div>${text}</div>
                <div class="timestamp">${new Date().toLocaleTimeString()}</div>
            `;
            messagesEl.appendChild(msgEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function logErrorMessage(text) {
            const msgEl = document.createElement('div');
            msgEl.className = 'message error';
            msgEl.innerHTML = `
                <div>${text}</div>
                <div class="timestamp">${new Date().toLocaleTimeString()}</div>
            `;
            messagesEl.appendChild(msgEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function logSystemMessage(text) {
            const msgEl = document.createElement('div');
            msgEl.className = 'message system';
            msgEl.innerHTML = `
                <div>${text}</div>
                <div class="timestamp">${new Date().toLocaleTimeString()}</div>
            `;
            messagesEl.appendChild(msgEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Get WebSocket close reason
        function getCloseReason(code) {
            const reasons = {
                1000: 'Normal closure',
                1001: 'Server is going away',
                1002: 'Protocol error',
                1003: 'Unsupported data',
                1005: 'No status received',
                1006: 'Abnormal closure',
                1007: 'Invalid frame payload data',
                1008: 'Policy violation',
                1009: 'Message too big',
                1010: 'Missing extension',
                1011: 'Internal server error',
                1012: 'Service restart',
                1013: 'Try again later',
                1014: 'Bad gateway',
                1015: 'TLS handshake failed'
            };
            return reasons[code] || `Unknown reason (code ${code})`;
        }
        
        // Event listeners
        sendBtn.addEventListener('click', () => {
            if (socket && socket.readyState === WebSocket.OPEN && inputEl.value.trim()) {
                const message = inputEl.value;
                socket.send(message);
                logMessage('Sent: ' + message);
                inputEl.value = '';
            }
        });
        
        inputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // Page became visible, ensure connection
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    isManualClose = false;
                    connect();
                }
            }
        });
        
        // Initial connection
        connect();
        
        // Keep connection alive when page is hidden
        window.addEventListener('beforeunload', () => {
            isManualClose = true;
            if (socket) {
                socket.close();
            }
        });
    </script>
</body>
</html>
